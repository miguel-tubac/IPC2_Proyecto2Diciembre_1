<!-- templates/menu_facturas_crear.html -->

<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Pedidos</title>
        <!-- Agrega el enlace a Bootstrap CSS -->
        <link
            rel="stylesheet"
            href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
        />
        {% load static %}
    </head>
    <body>
        {% include 'facturas/menu_facturas.html' %}
        <div class="container mt-5">
            <h1 class="mb-4">Pedidos</h1>

            <form id="clienteForm">
                {% csrf_token %}
                <div class="cliente-section form-group">
                    <label for="codigoCliente">Nit del Cliente:</label>
                    <input
                        type="text"
                        id="codigoCliente"
                        name="codigoCliente"
                        class="form-control"
                        placeholder="Ingrese el código del cliente"
                    />
                    <button
                        type="button"
                        id="buscarCliente"
                        class="btn btn-primary mt-2"
                    >
                        Buscar
                    </button>
                    <br />
                    <label for="nombreCliente" class="mt-3"
                        >Nombre del Cliente:</label
                    >
                    <input
                        type="text"
                        id="nombreCliente"
                        name="nombreCliente"
                        class="form-control"
                        readonly
                    />
                    <label for="direccionCliente" class="mt-2"
                        >Dirección del Cliente:</label
                    >
                    <input
                        type="text"
                        id="direccionCliente"
                        name="direccionCliente"
                        class="form-control"
                        readonly
                    />
                </div>
            </form>

            <div class="fecha-section form-group">
                <label for="fecha">Fecha:</label>
                <input type="date" id="fecha" class="form-control" />
            </div>

            <form id="productoForm">
                {% csrf_token %}
                <div class="producto-section form-group">
                    <div class="input-group">
                        <label class="mt-4" for="idProducto"
                            >Id del Producto:</label
                        >
                        <input
                            type="text"
                            id="idProducto"
                            name="idProducto"
                            class="form-control mt-4"
                            placeholder="Ingrese el código del producto"
                        />
                    </div>
                    <div class="input-group mt-3">
                        <label for="cantidadProducto">Cantidad:</label>
                        <input
                            type="number"
                            id="cantidadProducto"
                            name="cantidadProducto"
                            class="form-control"
                            min="1"
                            value="1"
                        />
                    </div>
                    <button
                        type="button"
                        id="agregarAlCarrito"
                        class="btn btn-success mt-2"
                    >
                        Agregar al Carrito
                    </button>
                </div>
            </form>

            <div class="container mt-5">
                <h2>Lista de Productos disponibles</h2>

                {% if lst_productos %}
                <table class="table table-bordered table-hover">
                    <thead class="thead-dark">
                        <tr>
                            <th scope="col">ID</th>
                            <th scope="col">Nombre</th>
                            <th scope="col">Descripcion</th>
                            <th scope="col">Precio</th>
                            <th scope="col">Stock</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for producto in lst_productos %}
                        <tr>
                            <td>{{ producto.0 }}</td>
                            <td>{{ producto.1 }}</td>
                            <td>{{ producto.2 }}</td>
                            <td>{{ producto.3 }}</td>
                            <td>{{ producto.4 }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p class="alert alert-info">No hay productos disponibles.</p>
                {% endif %}
            </div>

            <div class="carrito-section mt-4">
                <h2>Carrito de Compras</h2>
                <table id="tablaCarrito" class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Código</th>
                            <th>Nombre</th>
                            <th>Descripcion</th>
                            <th>Cantidad</th>
                            <th>Stock</th>
                            <th>Precio Unitario</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Aquí puedes iterar sobre los productos en el carrito -->
                        {% for item in carrito %}
                        <tr>
                            <td>{{ item.producto.codigo }}</td>
                            <td>{{ item.producto.nombre }}</td>
                            <td>{{ item.cantidad }}</td>
                            <td>{{ item.producto.precio }}</td>
                            <td>{{ item.total }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <button
                type="button"
                id="procesarPedido"
                class="btn btn-primary mt-3"
            >
                Procesar Pedido
            </button>
        </div>

        <!-- Agrega los enlaces a Bootstrap JS y cualquier otro script personalizado aquí -->
        <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <!-- Agrega tu script personalizado para manejar las funciones de búsqueda y procesar pedido -->
        <script>
            var datosTabla = [];
            document
                .getElementById('buscarCliente')
                .addEventListener('click', function () {
                    var nit_cliente =
                        document.getElementById('codigoCliente').value;

                    const xmlFilePath = "{% static 'clientes.xml' %}";
                    fetch(xmlFilePath)
                        .then((response) => response.text())
                        .then((xmlText) => {
                            // Parsear el contenido XML
                            const parser = new DOMParser();
                            const xmlDoc = parser.parseFromString(
                                xmlText,
                                'application/xml'
                            );

                            // Acceder al root del XML
                            const root = xmlDoc.documentElement;

                            // Obtener la lista de clientes
                            const clientes =
                                root.getElementsByTagName('cliente');

                            // Encontrar el cliente con el NIT proporcionado
                            let clienteEncontrado = null;
                            for (let i = 0; i < clientes.length; i++) {
                                const cliente = clientes[i];
                                const nitCliente = cliente.getAttribute('nit');

                                // Verificar si el NIT coincide
                                if (nitCliente === nit_cliente) {
                                    clienteEncontrado = cliente;
                                    break; // Romper el bucle si se encuentra el cliente
                                }
                            }

                            // Operar solo si se encontró el cliente
                            if (clienteEncontrado) {
                                const nombreCliente =
                                    clienteEncontrado.querySelector(
                                        'nombre'
                                    ).textContent;
                                const direccionCliente =
                                    clienteEncontrado.querySelector(
                                        'direccion'
                                    ).textContent;

                                // Aquí puedes actualizar los campos del HTML con los valores obtenidos
                                document.getElementById('nombreCliente').value =
                                    nombreCliente;
                                document.getElementById(
                                    'direccionCliente'
                                ).value = direccionCliente;
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Cliente Encontrado',
                                    text: `Nombre: ${nombreCliente}\nDirección: ${direccionCliente}`,
                                });
                            } else {
                                document.getElementById('nombreCliente').value =
                                    '';
                                document.getElementById(
                                    'direccionCliente'
                                ).value = '';
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Cliente No Encontrado',
                                    text: `No se encontró un cliente con NIT: ${nit_cliente}`,
                                });
                            }
                        })
                        .catch((error) => {
                            console.error(
                                'Error al cargar el archivo XML:',
                                error
                            );
                        });
                });
            document
                .getElementById('agregarAlCarrito')
                .addEventListener('click', function () {
                    var id_producto =
                        document.getElementById('idProducto').value;
                    const xmlFilePathProducto = "{% static 'productos.xml' %}";
                    console.log('Funciona');
                    fetch(xmlFilePathProducto)
                        .then((response) => response.text())
                        .then((xmlText) => {
                            // Parsear el contenido XML
                            const parser = new DOMParser();
                            const xmlDoc = parser.parseFromString(
                                xmlText,
                                'application/xml'
                            );

                            // Acceder al root del XML
                            const root = xmlDoc.documentElement;

                            // Obtener la lista de productos
                            const productos =
                                root.getElementsByTagName('producto');

                            // Encontrar el producto por el id
                            let producto_encontrado = null;
                            for (let i = 0; i < productos.length; i++) {
                                const producto = productos[i];
                                const idproducto = producto.getAttribute('id');

                                // Verificar si el Id coincide
                                if (idproducto === id_producto) {
                                    producto_encontrado = producto;
                                    break; // Romper el bucle si se encuentra el producto
                                }
                            }

                            // Operar solo si se encontró el producto
                            if (producto_encontrado) {
                                const nombreproducto =
                                    producto_encontrado.querySelector(
                                        'nombre'
                                    ).textContent;
                                const descripcionproducto =
                                    producto_encontrado.querySelector(
                                        'descripcion'
                                    ).textContent;
                                const precioproducto =
                                    producto_encontrado.querySelector(
                                        'precio'
                                    ).textContent;
                                const stockproducto =
                                    producto_encontrado.querySelector(
                                        'stock'
                                    ).textContent;
                                const cantidad_producto =
                                    document.getElementById(
                                        'cantidadProducto'
                                    ).value;
                                // Agregar una nueva fila a la tabla con id 'tablaCarrito'
                                const tablaCarrito =
                                    document.getElementById('tablaCarrito');
                                const nuevaFila = tablaCarrito.insertRow(-1); // -1 para agregar al final

                                // Agregar celdas a la nueva fila
                                const celdaId = nuevaFila.insertCell(0);
                                const celdaNombre = nuevaFila.insertCell(1);
                                const celdaDescripcion =
                                    nuevaFila.insertCell(2);
                                const celdaCantidad = nuevaFila.insertCell(3);
                                const celdaStock = nuevaFila.insertCell(4);
                                const celdaPrecio = nuevaFila.insertCell(5);
                                const celdatotal = nuevaFila.insertCell(6);

                                // Asignar valores a las celdas
                                celdaId.textContent = id_producto;
                                celdaNombre.textContent = nombreproducto;
                                celdaDescripcion.textContent =
                                    descripcionproducto;
                                celdaCantidad.textContent = cantidad_producto;
                                celdaPrecio.textContent = precioproducto;
                                celdaStock.textContent = stockproducto;
                                var total =
                                    parseFloat(cantidad_producto) *
                                    parseFloat(precioproducto);
                                total = total.toFixed(2);
                                filatabla = [
                                    nombreproducto,
                                    descripcionproducto,
                                    cantidad_producto,
                                    stockproducto,
                                    precioproducto,
                                    total,
                                ];
                                datosTabla.push(filatabla);
                                var datosTablaString =
                                    JSON.stringify(datosTabla);
                                sessionStorage.setItem(
                                    'datosTabla',
                                    datosTablaString
                                );
                                celdatotal.textContent = total.toString();

                                // Mostrar alerta de éxito con SweetAlert
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Producto Agregado al Carrito',
                                    text: `Producto: ${nombreproducto}\nPrecio: ${precioproducto}`,
                                });
                            } else {
                                // Manejar el caso en el que no se encontró el producto
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Producto No Encontrado',
                                    text: `No se encontró un producto con ID: ${id_producto}`,
                                });
                            }
                        })
                        .catch((error) => {
                            console.error(
                                'Error al cargar el archivo XML:',
                                error
                            );
                        });
                });
            function obtenerDatosDeLaTabla() {
                document.getElementById('procesarPedido');
                // Obtener la tabla por su ID
                const tablaCarrito = document.getElementById('tablaCarrito');

                // Crear una matriz para almacenar los datos de la tabla
                const datosTabla = [];

                // Iterar sobre las filas de la tabla
                for (let i = 1; i < tablaCarrito.rows.length; i++) {
                    const fila = tablaCarrito.rows[i];
                    const id = fila.cells[0].textContent;
                    const nombre = fila.cells[1].textContent;
                    const descripcion = fila.cells[2].textContent;
                    const cantidad = fila.cells[3].textContent;
                    const precio = fila.cells[4].textContent;
                    const stock = fila.cells[5].textContent;
                    const total = fila.cells[6].textContent;

                    // Crear un objeto con los datos de la fila
                    const datosFila = {
                        id: id,
                        nombre: nombre,
                        descripcion: descripcion,
                        cantidad: cantidad,
                        precio: precio,
                        stock: stock,
                        total: total,
                    };

                    // Agregar el objeto a la matriz
                    datosTabla.push(datosFila);
                }
            }
            document
                .getElementById('procesarPedido')
                .addEventListener('click', function () {
                    // Obtener los datos de la tabla
                    var datosTablaString = sessionStorage.getItem('datosTabla');
                    var datosTablaRecuperados = JSON.parse(datosTablaString);
                    console.log(datosTablaRecuperados);
                    // Enviar los datos al backend mediante una solicitud Ajax
                    fetch('/procesar_pedido/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken'), // Asegúrate de tener una función getCookie implementada
                        },
                        body: JSON.stringify(datosTabla),
                    })
                        .then((response) => response.json())
                        .then((data) => {
                            console.log('Respuesta del servidor:', data);
                            // Redirigir a la página de facturas
                            window.location.href = '/facturas/';
                        })
                        .catch((error) =>
                            console.error('Error en la solicitud:', error)
                        );
                });
            function getCookie(name) {
                var cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    var cookies = document.cookie.split(';');
                    for (var i = 0; i < cookies.length; i++) {
                        var cookie = cookies[i].trim();
                        if (
                            cookie.substring(0, name.length + 1) ===
                            name + '='
                        ) {
                            cookieValue = decodeURIComponent(
                                cookie.substring(name.length + 1)
                            );
                            break;
                        }
                    }
                }
                return cookieValue;
            }
        </script>
    </body>
</html>
